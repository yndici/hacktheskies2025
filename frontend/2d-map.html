<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>2D Map Planner</title>
    <script src="https://cdn.maptiler.com/maptiler-sdk-js/v3.8.0/maptiler-sdk.umd.min.js"></script>
    <link href="https://cdn.maptiler.com/maptiler-sdk-js/v3.8.0/maptiler-sdk.css" rel="stylesheet" />
        <style>
        :root{
            --primary-font: 'Inter', sans-serif;
            --gradient-start: #1abc9c; /* Vibrant Teal */
            --gradient-end: #8e44ad;   /* Vibrant Purple */
        }
        body { 
            margin: 0; 
            padding: 0; 
            display: flex; 
            height: 100vh; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            transition: background-color 0.4s, color 0.4s; 
            background-color: #f4f7f6; /* Default Light Mode background */
            color: #333;
        }
        #map { flex-grow: 1; }

        /* --- SIDEBAR ENHANCEMENTS --- */
        #sidebar { 
            width: 300px; 
            padding: 20px; 
            background-color: #f4f4f4; /* Light Mode Default */
            z-index: 10; 
            overflow-y: auto; 
            box-shadow: 4px 0 10px rgba(0, 0, 0, 0.1);
            transition: all 0.4s; /* Smooth transitions for everything */
        }
        
        /* Gradient Border Targeting */
        #sidebar-title { 
            position: relative; /* üîë 1. Essential for positioning the ::after element */
            padding-bottom: 10px; /* Increased padding to separate text from the line */
            margin-bottom: 20px;
            color: #2c3e50;
            font-size: 1.6em; 
            font-weight: 700;

            /* 2. Remove all standard border properties to avoid conflicts */
            border-style: none !important;
            border-bottom-width: 0 !important;
            border-image: none !important;
        }
        
        /* üîë 3. The universal, guaranteed method for a gradient line using a pseudo-element */
        #sidebar-title::after {
            content: '';
            position: absolute;
            bottom: 0; /* Position at the bottom of the heading's padded area */
            left: 0;
            width: 100%;
            height: 5px; /* Thickness of the gradient line */
            background-image: linear-gradient(to right, var(--gradient-start), var(--gradient-end));
        }

        /* LOCATION INFO BOX ENHANCEMENTS */
        .location-info { 
            margin-bottom: 15px; 
            padding: 12px; 
            border: 1px solid #ddd; 
            background-color: #fff; 
            border-radius: 6px; /* Rounded corners */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); /* Subtle lift */
            transition: background-color 0.4s; 
        }
        .location-info h4 { margin-top: 0; }
        
        /* INPUT FIELD STYLES */
        #location-input { 
            padding: 10px; /* Increased padding */
            width: 100%; 
            box-sizing: border-box; 
            margin-bottom: 5px; 
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 1em;
        }

        /* --- BUTTON ELEVATION --- */
        button { 
            padding: 12px 15px; 
            width: 100%; 
            cursor: pointer; 
            border: none; 
            border-radius: 6px; /* Rounded corners */
            font-size: 1em;
            font-weight: 600;
            transition: all 0.2s ease; 
            
            /* üîë ELEVATION: Lifted Shadow */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        
        button:hover {
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.3);
            transform: translateY(-1px); /* Move button up 1 pixel */
        }

        button:active {
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); 
            transform: translateY(2px); /* Simulate press down */
        }

        /* Specific Button Colors */
        #visualizeButton { 
            background-color: #28a745; 
            color: white; 
            margin-top: 10px;
        }
        #visualizeButton:hover {
            background-color: #1e8449; /* Darker green on hover */
        }
        #visualizeButton:disabled { 
            opacity: 0.5px; 
            cursor: not-allowed;
            box-shadow: none;
            transform: none; /* Disable elevation on disabled button */
        }
        #search-btn { 
            background-color: #ddc424 0%, #f39c12; 
            background-image: linear-gradient(180deg, #ddc424 0% , #f39c12 100%);
            margin-top: 5px; 
        }
        #search-btn:hover {
            background-color: #e67e22;
        }

        /* --- DARK MODE STYLES --- */
        .dark-mode body { 
            background-color: #121212 !important; 
            color: #f4f4f4 !important; 
        }
        
        .dark-mode #sidebar { 
            background-color: #1e1e1e !important; 
            color: #f4f4f4 !important;
            box-shadow: 4px 0 10px rgba(0, 0, 0, 0.5);
        }
        
        /* Dark mode target for the specific heading ID */
        .dark-mode #sidebar-title {
            color: #f4f4f4 !important;
        }
        
        /* Dark Mode Gradient Override */
        .dark-mode #sidebar-title::after {
            /* Adjust the gradient for better contrast in dark mode (e.g., brighter) */
            background-image: linear-gradient(to right, #8ab4f8, #f4b4b4);
        }

        .dark-mode .location-info { 
            background-color: #2c2c2c !important; 
            border-color: #444 !important;
        }
        
        .dark-mode a { 
            color: #8ab4f8 !important; 
        }

        /* Dark Mode Inputs */
        .dark-mode #location-input {
            background-color: #333 !important;
            color: #f4f4f4 !important;
            border-color: #444 !important;
        }

        /* --- GLOBBIE JR. MASCOT WIDGET STYLES --- */
        #globbie-widget {
            position: fixed; /* stays while scrolling */
            bottom: 20px;
            right: 20px;
            width: 200px;
            height: 200px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 100030; /* HIGHER than the message box so mascot is always on top */
            display: flex;
            justify-content: center;
            align-items: center;
            transition: transform 0.2s, box-shadow 0.2s;
            overflow: hidden;
            animation: float 4s ease-in-out infinite;
            pointer-events: auto;
        }

        #globbie-widget:hover { transform: scale(1.06); }

        #globbie-widget img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            padding: 5px; 
        }

        /* Keyframe Animation for a Bobbing/Floating Effect */
        @keyframes float {
            0% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-8px); /* Moves up 8 pixels */
            }
            100% {
                transform: translateY(0);
            }
        }

        /* Keyframe Animation for Click Interaction */
        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-15px); /* Jump up higher */
            }
        }

        .bouncing {
            /* Temporarily override the float animation with a bounce */
            animation: bounce 0.5s ease-out !important; 
        }

        /* --- GLOBBIE JR. MESSAGE BUBBLE STYLES --- */
         /* Keep message bubble slightly left of the mascot and under it in stacking order */
        #globbie-message-box {
            position: fixed;
            bottom: 110px;
            right: 240px; /* push left so the mascot (on the right) doesn't overlap text */
            z-index: 100020; /* LOWER than widget so mascot is visually on top */
            max-width: 260px;
            width: auto;
            box-sizing: border-box;
            padding: 10px 14px;
            background-color: #f8f8f8;
            color: #333;
            border: 5px dotted #ddd;
            border-radius: 10px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
            font-size: 0.9em;
            line-height: 1.25;
            word-wrap: break-word;
            white-space: normal;
            opacity: 0;
            visibility: hidden;
            pointer-events: none; /* allow clicks through when hidden */
            transform: translateY(10px);
            transition: opacity 0.28s ease, transform 0.28s ease, visibility 0.28s;
        }

        .globbie-message-bubble.visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
            pointer-events: auto; /* bubble accepts interaction when visible */
        }

        /* CLASS APPLIED BY JAVASCRIPT TO MAKE IT VISIBLE */
        .globbie-message-bubble.visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
            pointer-events: auto; 
        }

        /* Arrow/Tail for the Speech Bubble (Points toward the mascot) */
        #globbie-message-box::after {
            content: "";
            position: absolute;
            top: 50%;
            right: -10px; /* Positions the arrow tip just outside the box edge */
            transform: translateY(-50%);
            border-width: 10px 0 10px 10px; 
            border-style: solid;
            /* Matches the light background color of the box */
            border-color: transparent transparent transparent #f8f8f8; 
        }

        /* Dark Mode Message Box Overrides */
        .dark-mode #globbie-message-box {
            background-color: #333; /* Dark background */
            color: #f4f4f4; /* Sets the container text color to white */
            border-color: #555;
        }

        /* CRITICAL: Fix for dark mode text color (targets the inner <p> element) */
        .dark-mode #globbie-message-box p#globbieMessage {
            color: #f4f4f4 !important; 
        }

        /* Dark Mode Arrow/Tail Fix */
        .dark-mode #globbie-message-box::after {
            /* Matches the dark background color of the box */
            border-color: transparent transparent transparent #333;
        }

    </style>
</head>
<body>
    <div id="map"></div>
    <div id="sidebar">
        <!-- I've added a unique ID to the heading here -->
        <h2 id="sidebar-title">Plan Your Journey</h2> 

        <div style="margin-bottom: 20px;">
            <input type="text" id="location-input" placeholder="Search for a location...">
            <button id="search-btn">Search & Zoom</button>
            <p id="search-status" style="font-size: 0.8em; color: #555; margin: 5px 0 0 0;">Start or click on the map.</p>
        </div>
        
        <div id="start-info" class="location-info">
            <h4>Start Point (A):</h4>
            <p id="start-coords">Click map to set.</p>
        </div>
        
        <div id="end-info" class="location-info">
            <h4>End Point (B):</h4>
            <p id="end-coords">Click map to set.</p>
        </div>
        
        <button id="visualizeButton" disabled>Visualize Journey</button>

        <!-- Globbie Sidebar Panel -->
        <div id="globbie-sidebar" class="location-info" aria-live="polite" style="margin-top:18px;">
            <h4>Globbie 3.0</h4>
            <p id="globbieSidebarMessage" style="margin:0 0 8px 0; line-height:1.25;">Hi! I'm Globbie Jr. Let's make your travel more sustainable!</p>
            <div style="display:flex; gap:8px;">
                <button id="globbieSpeakBtn" class="start-button" style="flex:1;padding:8px 10px;font-weight:600;">Speak</button>
                <label style="display:flex;align-items:center;gap:6px;margin:0;">
                    <input id="globbieAutoSpeak" type="checkbox" checked>
                    <small>Auto‚Äëspeak</small>
                </label>
            </div>
        </div>
        
        <div style="margin-top: 20px; border-top: 1px solid #ddd; padding-top: 10px;">
            <p><a id="globe-back-link" href="index-globe.html" style="color: #007bff;">‚Üê Back to Globe</a></p>
        </div>
    </div>

    <!-- Globbie Jr. widget (image file 'globbie.png' is expected in same folder or adjust src) -->
    <div id="globbie-widget" title="Globbie Jr. - Click for Insight">
        <img src="globbie.png" alt="Globbie Jr.">
    </div>

    <div id="globbie-message-box" class="globbie-message-bubble" aria-live="polite">
        <p id="globbieMessage" style="margin:0;line-height:1.25;">Hi ‚Äî click me for eco tips!</p>
    </div>
    
        <script>
        // --- 1. THEME READING FUNCTIONALITY ---
        function getUrlParams() {
            const params = {};
            new URLSearchParams(window.location.search).forEach((value, key) => {
                params[key] = value; 
            });
            return params;
        }

        const params = getUrlParams();
        // üîë Read the theme mode from the URL, or default to 'dark'
        let currentMode = params.mode || 'dark'; 

        // üîë Apply the theme to the 2D map page's body
        if (currentMode === 'dark') {
            document.body.classList.add('dark-mode');
            // üîë NEW JAVASCRIPT FIX: Apply direct style changes üîë
            applyDarkModeTextStyles();
        } else {
            document.body.classList.remove('dark-mode');
        }

        // --- FUNCTION TO FORCE TEXT COLOR TO WHITE ---
        function applyDarkModeTextStyles() {
            const sidebar = document.getElementById('sidebar');
            
            // Ensure sidebar has dark background and light text
            sidebar.style.backgroundColor = '#1e1e1e'; // Dark background
            sidebar.style.color = '#f4f4f4'; // Light text for direct children

            // Select all paragraph and heading elements within the sidebar
            const elementsToLighten = sidebar.querySelectorAll('p, h2, h4, .location-info, a');
            
            elementsToLighten.forEach(el => {
                // Apply white text color directly to override CSS conflicts
                el.style.color = '#f4f4f4'; 

                // Special handling for link color
                if (el.tagName === 'A') {
                    el.style.color = '#8ab4f8'; 
                }
                
                // Ensure location info blocks have a visible background
                if (el.classList.contains('location-info')) {
                    el.style.backgroundColor = '#2c2c2c';
                }
            });
            
            // Manually fix the input field background/text color for dark mode
            document.getElementById('location-input').style.backgroundColor = '#333';
            document.getElementById('location-input').style.color = '#f4f4f4';
            
            // Fix the search status text
            document.getElementById('search-status').style.color = '#ccc';
        }
        
        // üõë IMPORTANT: REPLACE WITH YOUR MAPTILER KEY
        maptilersdk.config.apiKey = '5wWbrG952VRV7YfNLV9j';
        
        // ... (rest of your script remains here, unchanged) ...

        let startMarker, endMarker;
        let startCoords = null;
        let endCoords = null;
        
        // üîë Set map style based on theme mode
        const mapStyle = (currentMode === 'dark') ? maptilersdk.MapStyle.WINTER : maptilersdk.MapStyle.STREETS;
        
        const map = new maptilersdk.Map({
            container: 'map',
            style: mapStyle, 
            center: [0, 0], 
            zoom: 2
        });
        
        const visualizeButton = document.getElementById('visualizeButton');


        // --- SEARCH FUNCTIONALITY ---
        // ... (Your searchLocation function remains the same) ...
        async function searchLocation() {
            const inputElement = document.getElementById('location-input');
            const query = inputElement.value.trim();
            const status = document.getElementById('search-status');
            if (!query) return;

            // Define the specific location data
            const specificLocation = {
                name: "YSpace Markham",
                queryMatch: "YSPACE MARKHAM", // Use uppercase for robust matching
                coords: { lat: 43.8497964, lng: -79.3255077 } // Approximate Coordinates for 169 Enterprise Blvd
            };

            // Check for the specific location match
            if (query.toUpperCase().includes(specificLocation.queryMatch)) {
                
                const { lat, lng } = specificLocation.coords;

                map.flyTo({ 
                    center: [lng, lat], 
                    zoom: 15, // Zoom in closer for a specific building
                    duration: 1500 
                });
                
                status.textContent = `Zoomed to: ${specificLocation.name}`;
                return; // Stop execution here since we found the custom location
            }

            // --- Default Search (If no custom match found) ---
            const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=1`;
            status.textContent = "Searching...";
            
            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data && data.length > 0) {
                    const lat = parseFloat(data[0].lat);
                    const lng = parseFloat(data[0].lon);
                    
                    map.flyTo({ 
                        center: [lng, lat], 
                        zoom: 10, 
                        duration: 1500 
                    });
                    
                    status.textContent = `Zoomed to: ${data[0].display_name.split(',')[0]}`;

                } else {
                    status.textContent = `Location not found: "${query}"`;
                }
            } catch (error) {
                console.error("Geocoding error:", error);
                status.textContent = "Error connecting to search service.";
            }
        }

        document.getElementById('search-btn').addEventListener('click', searchLocation);
        document.getElementById('location-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                searchLocation();
            }
        });

        document.getElementById('search-btn').addEventListener('click', searchLocation);
        document.getElementById('location-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                searchLocation();
            }
        });
        // --- END OF SEARCH FUNCTIONALITY ---


        function updateCoordinates(type, coords) {
            const lon = coords.lng.toFixed(4);
            const lat = coords.lat.toFixed(4);
            const displayId = type === 'start' ? 'start-coords' : 'end-coords';
            document.getElementById(displayId).textContent = `Lon: ${lon}, Lat: ${lat}`;

            if (type === 'start') {
                startCoords = coords;
            } else {
                endCoords = coords;
            }

            if (startCoords && endCoords) {
                visualizeButton.disabled = false;
            }
        }

        map.on('click', (e) => {
            const coords = e.lngLat;
            
            if (!startCoords) {
                if (startMarker) startMarker.remove();
                startMarker = new maptilersdk.Marker({ color: '#3498db' }).setLngLat(coords).addTo(map);
                updateCoordinates('start', coords);
            } else if (!endCoords) {
                if (endMarker) endMarker.remove();
                endMarker = new maptilersdk.Marker({ color: '#e74c3c' }).setLngLat(coords).addTo(map);
                updateCoordinates('end', coords);
            } else {
                // Reset state
                startCoords = null;
                endCoords = null;
                startMarker.remove();
                endMarker.remove();
                document.getElementById('start-coords').textContent = 'Click map to set.';
                document.getElementById('end-coords').textContent = 'Click map to set.';
                visualizeButton.disabled = true;
                map.fire('click', e);
            }
        });

        visualizeButton.addEventListener('click', () => {
            if (startCoords && endCoords) {
                const startLon = startCoords.lng.toFixed(4);
                const startLat = startCoords.lat.toFixed(4);
                const endLon = endCoords.lng.toFixed(4);
                const endLat = endCoords.lat.toFixed(4);

                // üîë Fix: Pass the current theme mode back to the globe page
                const redirectURL = `index-globe.html?s_lon=${startLon}&s_lat=${startLat}&e_lon=${endLon}&e_lat=${endLat}&mode=${currentMode}`;
                window.location.href = redirectURL;
            } else {
                // IMPORTANT: Removed alert() as per instructions
                console.error('Please select both a start and end point.');
            }
        });

        // üîë Set the theme for the "Back to Globe" link
        document.getElementById('globe-back-link').href = `index-globe.html?mode=${currentMode}`;

        // --- Globbie Jr. Initialization (robust retry + message cycling) ---
        (function initGlobbie(retries = 8, delay = 120) {
            const widget = document.getElementById('globbie-widget');
            const bubble = document.getElementById('globbie-message-box');
            const msgEl = document.getElementById('globbieMessage');

            // sidebar elements for persistent display & controls
            const sidebarMsgEl = document.getElementById('globbieSidebarMessage');
            const speakBtn = document.getElementById('globbieSpeakBtn');
            const autoSpeakCheckbox = document.getElementById('globbieAutoSpeak');

            if (!widget || !bubble || !msgEl) {
                if (retries > 0) return setTimeout(() => initGlobbie(retries - 1, delay), delay);
                return;
            }
            console.log('Globbie Jr. initialized');

            const messages = [
                "üåø Did you know that air travel contributes around 2.5% of global CO‚ÇÇ emissions?",
                "üí® Short-haul flights (under 1,500 km) are the least efficient way to travel per passenger mile.",
                "üí° Visualize your carbon footprint to reduce your impact! That's why I'm here.",
                "‚≠ê The most sustainable route is often the one you don't take. Consider video conferencing!",
                "üå± Compare flight data carefully‚Äînewer planes are significantly more fuel-efficient.",
                "‚ú® Thanks for planning your journey mindfully!"
    
            ];
            let idx = 0;

            function speakText(text) {
                if (!('speechSynthesis' in window)) {
                    console.warn('Speech synthesis not supported in this browser');
                    return;
                }
                try {
                    // strip emoji/symbols for clearer TTS
                    const cleaned = text.replace(/[\u{1F300}-\u{1FAFF}\u2600-\u26FF]/gu, '');
                    window.speechSynthesis.cancel();
                    const utter = new SpeechSynthesisUtterance(cleaned);
                    utter.lang = 'en-US';
                    utter.rate = 1.0;
                    window.speechSynthesis.speak(utter);
                } catch (e) {
                    console.warn('speakText error', e);
                }
            }

            widget.addEventListener('click', () => {
                const msg = messages[idx];
                msgEl.textContent = msg;
                if (sidebarMsgEl) sidebarMsgEl.textContent = msg.replace(/[\u{1F300}-\u{1FAFF}\u2600-\u26FF]/gu, '');
                idx = (idx + 1) % messages.length;

                bubble.classList.add('visible');

                widget.classList.add('bouncing');
                setTimeout(() => widget.classList.remove('bouncing'), 450);

                clearTimeout(widget._globbieHideTimer);
                widget._globbieHideTimer = setTimeout(() => bubble.classList.remove('visible'), 5000);

                // auto-speak if enabled
                if (autoSpeakCheckbox && autoSpeakCheckbox.checked) speakText(msg);
            });

            // sidebar Speak button
            if (speakBtn) {
                speakBtn.addEventListener('click', () => {
                    const text = (sidebarMsgEl && sidebarMsgEl.textContent) || messages[idx] || messages[0];
                    speakText(text);
                });
            }
        })();

         // Ensure Globbie doesn't cover the sidebar: position it to the right of the sidebar when present.
        (function keepGlobbieClearOfSidebar() {
            const widget = document.getElementById('globbie-widget');
            const sidebar = document.getElementById('sidebar');
            if (!widget || !sidebar) return;

            function updatePosition() {
                const vw = window.innerWidth || document.documentElement.clientWidth;
                // On small screens keep the widget at the edge (sidebar may overlay)
                if (vw <= 720) {
                    widget.style.right = '20px';
                    widget.style.left = 'auto';
                    return;
                }

                // If sidebar is visible (not hidden) push the widget to the right of it.
                const sidebarStyle = getComputedStyle(sidebar);
                const isVisible = sidebarStyle.display !== 'none' && sidebarStyle.visibility !== 'hidden' && sidebarStyle.transform !== 'translateX(-100%)';

                if (isVisible) {
                    // Use the sidebar offsetWidth (falls back to 300)
                    const sidebarWidth = sidebar.offsetWidth || 300;
                    // Add a small gap (20px)
                    widget.style.right = `calc(${20}px + ${sidebarWidth}px)`;
                    widget.style.left = 'auto';
                } else {
                    widget.style.right = '20px';
                    widget.style.left = 'auto';
                }
            }

            // Update on load / resize
            window.addEventListener('resize', updatePosition);
            window.addEventListener('orientationchange', updatePosition);
            updatePosition();

            // Observe changes to the sidebar (class toggles, show/hide)
            const mo = new MutationObserver(() => updatePosition());
            mo.observe(sidebar, { attributes: true, attributeFilter: ['class', 'style'] });

            // safeguard: recalc after a short delay in case layout animates
            window.setTimeout(updatePosition, 350);
        })();
    </script>

</body>
</html>