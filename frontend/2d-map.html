<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>2D Map Planner</title>
    <script src="https://cdn.maptiler.com/maptiler-sdk-js/v3.8.0/maptiler-sdk.umd.min.js"></script>
    <link href="https://cdn.maptiler.com/maptiler-sdk-js/v3.8.0/maptiler-sdk.css" rel="stylesheet" />
        <style>
        /*Basic Reset and Layout*/
        :root{
            --primary-font: 'Inter', sans-serif;
            --gradient-start: #1abc9c; 
            --gradient-end: #8e44ad;   
        }
        body { 
            margin: 0; 
            padding: 0; 
            display: flex; 
            height: 100vh; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            transition: background-color 0.4s, color 0.4s; 
            background-color: #f4f7f6; 
            color: #333;
        }
        #map { flex-grow: 1; }

        #sidebar { 
            width: 300px; 
            padding: 20px; 
            background-color: #f4f4f4; 
            z-index: 10; 
            overflow-y: auto; 
            box-shadow: 4px 0 10px rgba(0, 0, 0, 0.1);
            transition: all 0.4s;
        }
        
        #sidebar-title { 
            position: relative; 
            padding-bottom: 10px; 
            margin-bottom: 20px;
            color: #2c3e50;
            font-size: 1.6em; 
            font-weight: 700;

            border-style: none !important;
            border-bottom-width: 0 !important;
            border-image: none !important;
        }
        
        #sidebar-title::after {
            content: '';
            position: absolute;
            bottom: 0; 
            left: 0;
            width: 100%;
            height: 5px; 
            background-image: linear-gradient(to right, var(--gradient-start), var(--gradient-end));
        }

        /* Location Info Boxes */
        .location-info { 
            margin-bottom: 15px; 
            padding: 12px; 
            border: 1px solid #ddd; 
            background-color: #fff; 
            border-radius: 6px; 
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); 
            transition: background-color 0.4s; 
        }
        .location-info h4 { margin-top: 0; }
        
        #location-input { 
            padding: 10px; 
            width: 100%; 
            box-sizing: border-box; 
            margin-bottom: 5px; 
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 1em;
        }

        /* Buttons */
        button { 
            padding: 12px 15px; 
            width: 100%; 
            cursor: pointer; 
            border: none; 
            border-radius: 6px; 
            font-size: 1em;
            font-weight: 600;
            transition: all 0.2s ease; 
            
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        
        button:hover {
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.3);
            transform: translateY(-1px); 
        }

        button:active {
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); 
            transform: translateY(2px); 
        }

        #visualizeButton { 
            background-color: #28a745; 
            color: white; 
            margin-top: 10px;
        }
        #visualizeButton:hover {
            background-color: #1e8449; 
        }
        #visualizeButton:disabled { 
            opacity: 0.5px; 
            cursor: not-allowed;
            box-shadow: none;
            transform: none; 
        }
        #search-btn { 
            background-color: #ddc424 0%, #f39c12; 
            background-image: linear-gradient(180deg, #ddc424 0% , #f39c12 100%);
            margin-top: 5px; 
        }
        #search-btn:hover {
            background-color: #e67e22;
        }

        /* Dark Mode Styles */
        .dark-mode body { 
            background-color: #121212 !important; 
            color: #f4f4f4 !important; 
        }
        
        .dark-mode #sidebar { 
            background-color: #1e1e1e !important; 
            color: #f4f4f4 !important;
            box-shadow: 4px 0 10px rgba(0, 0, 0, 0.5);
        }
        
        .dark-mode #sidebar-title {
            color: #f4f4f4 !important;
        }
        
        .dark-mode #sidebar-title::after {
            background-image: linear-gradient(to right, #8ab4f8, #f4b4b4);
        }

        .dark-mode .location-info { 
            background-color: #2c2c2c !important; 
            border-color: #444 !important;
        }
        
        .dark-mode a { 
            color: #8ab4f8 !important; 
        }

        .dark-mode #location-input {
            background-color: #333 !important;
            color: #f4f4f4 !important;
            border-color: #444 !important;
        }

        /* Globbie Jr. Styles */
        #globbie-widget {
            position: fixed; 
            bottom: 20px;
            right: 20px;
            width: 200px;
            height: 200px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 100030; 
            display: flex;
            justify-content: center;
            align-items: center;
            transition: transform 0.2s, box-shadow 0.2s;
            overflow: hidden;
            animation: float 4s ease-in-out infinite;
            pointer-events: auto;
        }

        #globbie-widget:hover { transform: scale(1.06); }

        #globbie-widget img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            padding: 5px; 
        }
        @keyframes float {
            0% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-8px); 
            }
            100% {
                transform: translateY(0);
            }
        }

        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-15px); 
            }
        }

        .bouncing {
            animation: bounce 0.5s ease-out !important; 
        }

        /* Globbie Jr. Message Bubble */
        #globbie-message-box {
            position: fixed;
            bottom: 110px;
            right: 240px; 
            z-index: 100020; 
            max-width: 260px;
            width: auto;
            box-sizing: border-box;
            padding: 10px 14px;
            background-color: #f8f8f8;
            color: #333;
            border: 5px dotted #ddd;
            border-radius: 10px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
            font-size: 0.9em;
            line-height: 1.25;
            word-wrap: break-word;
            white-space: normal;
            opacity: 0;
            visibility: hidden;
            pointer-events: none; 
            transform: translateY(10px);
            transition: opacity 0.28s ease, transform 0.28s ease, visibility 0.28s;
        }

        .globbie-message-bubble.visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
            pointer-events: auto; 
        }

        .globbie-message-bubble.visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
            pointer-events: auto; 
        }

        #globbie-message-box::after {
            content: "";
            position: absolute;
            top: 50%;
            right: -10px; 
            transform: translateY(-50%);
            border-width: 10px 0 10px 10px; 
            border-style: solid;
            border-color: transparent transparent transparent #f8f8f8; 
        }

        .dark-mode #globbie-message-box {
            background-color: #333; 
            color: #f4f4f4; 
            border-color: #555;
        }

        .dark-mode #globbie-message-box p#globbieMessage {
            color: #f4f4f4 !important; 
        }

        .dark-mode #globbie-message-box::after {
            border-color: transparent transparent transparent #333;
        }

    </style>
</head>
<body>
    <div id="map"></div>
    <div id="sidebar">
        <h2 id="sidebar-title">Plan Your Journey</h2> 

        <div style="margin-bottom: 20px;">
            <input type="text" id="location-input" placeholder="Search for a location...">
            <button id="search-btn">Search & Zoom</button>
            <p id="search-status" style="font-size: 0.8em; color: #555; margin: 5px 0 0 0;">Start or click on the map.</p>
        </div>
        
        <div id="start-info" class="location-info">
            <h4>Start Point (A):</h4>
            <p id="start-coords">Click map to set.</p>
        </div>
        
        <div id="end-info" class="location-info">
            <h4>End Point (B):</h4>
            <p id="end-coords">Click map to set.</p>
        </div>
        
        <button id="visualizeButton" disabled>Visualize Journey</button>

        <!-- Globbie Sidebar Panel -->
        <div id="globbie-sidebar" class="location-info" aria-live="polite" style="margin-top:18px;">
            <h4>Globbie Jr.</h4>
            <p id="globbieSidebarMessage" style="margin:0 0 8px 0; line-height:1.25;">Hi! I'm Globbie Jr. Let's make your travel more sustainable!</p>
            <div style="display:flex; gap:8px;">
                <button id="globbieSpeakBtn" class="start-button" style="flex:1;padding:8px 10px;font-weight:600;">Speak</button>
                <label style="display:flex;align-items:center;gap:6px;margin:0;">
                    <input id="globbieAutoSpeak" type="checkbox" checked>
                    <small>Auto‚Äëspeak</small>
                </label>
            </div>
        </div>

        <div style="margin-top: 20px; border-top: 1px solid #ddd; padding-top: 10px;">
            <p><a id="globe-back-link" href="index-globe.html" style="color: #007bff;">‚Üê Back to Globe</a></p>
        </div>
    </div>

    <div id="globbie-widget" title="Globbie Jr. - Click for Insight">
        <img src="globbie.png" alt="Globbie Jr.">
    </div>

    <div id="globbie-message-box" class="globbie-message-bubble" aria-live="polite">
        <p id="globbieMessage" style="margin:0;line-height:1.25;">Hi ‚Äî click me for eco tips!</p>
    </div>
    
        <!-- URL Parameters-->
        <script>
        function getUrlParams() {
            const params = {};
            new URLSearchParams(window.location.search).forEach((value, key) => {
                params[key] = value; 
            });
            return params;
        }

        const params = getUrlParams();
        let currentMode = params.mode || 'dark'; 

        if (currentMode === 'dark') {
            document.body.classList.add('dark-mode');
            applyDarkModeTextStyles();
        } else {
            document.body.classList.remove('dark-mode');
        }

        function applyDarkModeTextStyles() {
            const sidebar = document.getElementById('sidebar');
            
            sidebar.style.backgroundColor = '#1e1e1e'; 
            sidebar.style.color = '#f4f4f4';

            const elementsToLighten = sidebar.querySelectorAll('p, h2, h4, .location-info, a');
            
            elementsToLighten.forEach(el => {
    
                el.style.color = '#f4f4f4'; 

                if (el.tagName === 'A') {
                    el.style.color = '#8ab4f8'; 
                }
                
                if (el.classList.contains('location-info')) {
                    el.style.backgroundColor = '#2c2c2c';
                }
            });
            
            document.getElementById('location-input').style.backgroundColor = '#333';
            document.getElementById('location-input').style.color = '#f4f4f4';
            document.getElementById('search-status').style.color = '#ccc';
        }
        
        maptilersdk.config.apiKey = '5wWbrG952VRV7YfNLV9j';

        let startMarker, endMarker;
        let startCoords = null;
        let endCoords = null;
        
        const mapStyle = (currentMode === 'dark') ? maptilersdk.MapStyle.WINTER : maptilersdk.MapStyle.STREETS;
        
        const map = new maptilersdk.Map({
            container: 'map',
            style: mapStyle, 
            center: [0, 0], 
            zoom: 2
        });
        
        const visualizeButton = document.getElementById('visualizeButton');

        async function searchLocation() {
            const inputElement = document.getElementById('location-input');
            const query = inputElement.value.trim();
            const status = document.getElementById('search-status');
            if (!query) return;

            //Custom Location
            const specificLocation = {
                name: "YSpace Markham",
                queryMatch: "YSPACE MARKHAM", 
                coords: { lat: 43.8497964, lng: -79.3255077 }
            };

            // Check for the specific location match
            if (query.toUpperCase().includes(specificLocation.queryMatch)) {
                
                const { lat, lng } = specificLocation.coords;

                map.flyTo({ 
                    center: [lng, lat], 
                    zoom: 15,
                    duration: 1500 
                });
                
                status.textContent = `Zoomed to: ${specificLocation.name}`;
                return; 
            }

            const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=1`;
            status.textContent = "Searching...";
            
            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data && data.length > 0) {
                    const lat = parseFloat(data[0].lat);
                    const lng = parseFloat(data[0].lon);
                    
                    map.flyTo({ 
                        center: [lng, lat], 
                        zoom: 10, 
                        duration: 1500 
                    });
                    
                    status.textContent = `Zoomed to: ${data[0].display_name.split(',')[0]}`;

                } else {
                    status.textContent = `Location not found: "${query}"`;
                }
            } catch (error) {
                console.error("Geocoding error:", error);
                status.textContent = "Error connecting to search service.";
            }
        }

        document.getElementById('search-btn').addEventListener('click', searchLocation);
        document.getElementById('location-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                searchLocation();
            }
        });

        document.getElementById('search-btn').addEventListener('click', searchLocation);
        document.getElementById('location-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                searchLocation();
            }
        });

        function updateCoordinates(type, coords) {
            const lon = coords.lng.toFixed(4);
            const lat = coords.lat.toFixed(4);
            const displayId = type === 'start' ? 'start-coords' : 'end-coords';
            document.getElementById(displayId).textContent = `Lon: ${lon}, Lat: ${lat}`;

            if (type === 'start') {
                startCoords = coords;
            } else {
                endCoords = coords;
            }

            if (startCoords && endCoords) {
                visualizeButton.disabled = false;
            }
        }

        map.on('click', (e) => {
            const coords = e.lngLat;
            
            if (!startCoords) {
                if (startMarker) startMarker.remove();
                startMarker = new maptilersdk.Marker({ color: '#3498db' }).setLngLat(coords).addTo(map);
                updateCoordinates('start', coords);
            } else if (!endCoords) {
                if (endMarker) endMarker.remove();
                endMarker = new maptilersdk.Marker({ color: '#e74c3c' }).setLngLat(coords).addTo(map);
                updateCoordinates('end', coords);
            } else {
                startCoords = null;
                endCoords = null;
                startMarker.remove();
                endMarker.remove();
                document.getElementById('start-coords').textContent = 'Click map to set.';
                document.getElementById('end-coords').textContent = 'Click map to set.';
                visualizeButton.disabled = true;
                map.fire('click', e);
            }
        });

        visualizeButton.addEventListener('click', () => {
            if (startCoords && endCoords) {
                const startLon = startCoords.lng.toFixed(4);
                const startLat = startCoords.lat.toFixed(4);
                const endLon = endCoords.lng.toFixed(4);
                const endLat = endCoords.lat.toFixed(4);

                const redirectURL = `index-globe.html?s_lon=${startLon}&s_lat=${startLat}&e_lon=${endLon}&e_lat=${endLat}&mode=${currentMode}`;
                window.location.href = redirectURL;
            } else {
                console.error('Please select both a start and end point.');
            }
        });

        document.getElementById('globe-back-link').href = `index-globe.html?mode=${currentMode}`;

        //Globbie Jr. Initialization 
        (function initGlobbie(retries = 8, delay = 120) {
            const widget = document.getElementById('globbie-widget');
            const bubble = document.getElementById('globbie-message-box');
            const msgEl = document.getElementById('globbieMessage');

            const sidebarMsgEl = document.getElementById('globbieSidebarMessage');
            const speakBtn = document.getElementById('globbieSpeakBtn');
            const autoSpeakCheckbox = document.getElementById('globbieAutoSpeak');

            if (!widget || !bubble || !msgEl) {
                if (retries > 0) return setTimeout(() => initGlobbie(retries - 1, delay), delay);
                return;
            }
            console.log('Globbie Jr. initialized');

            const messages = [
                "üåø Did you know that air travel contributes around 2.5% of global CO‚ÇÇ emissions?",
                "üí® Short-haul flights (under 1,500 km) are the least efficient way to travel per passenger mile.",
                "üí° Visualize your carbon footprint to reduce your impact! That's why I'm here.",
                "‚≠ê The most sustainable route is often the one you don't take. Consider video conferencing!",
                "üå± Compare flight data carefully‚Äînewer planes are significantly more fuel-efficient.",
                "‚ú® Thanks for planning your journey mindfully!"
    
            ];
            let idx = 0;

            function speakText(text) {
                if (!('speechSynthesis' in window)) {
                    console.warn('Speech synthesis not supported in this browser');
                    return;
                }
                try {
                    const cleaned = text.replace(/[\u{1F300}-\u{1FAFF}\u2600-\u26FF]/gu, '');
                    window.speechSynthesis.cancel();
                    const utter = new SpeechSynthesisUtterance(cleaned);
                    utter.lang = 'en-US';
                    utter.rate = 1.0;
                    window.speechSynthesis.speak(utter);
                } catch (e) {
                    console.warn('speakText error', e);
                }
            }

            widget.addEventListener('click', () => {
                const msg = messages[idx];
                msgEl.textContent = msg;
                if (sidebarMsgEl) sidebarMsgEl.textContent = msg.replace(/[\u{1F300}-\u{1FAFF}\u2600-\u26FF]/gu, '');
                idx = (idx + 1) % messages.length;

                bubble.classList.add('visible');

                widget.classList.add('bouncing');
                setTimeout(() => widget.classList.remove('bouncing'), 450);

                clearTimeout(widget._globbieHideTimer);
                widget._globbieHideTimer = setTimeout(() => bubble.classList.remove('visible'), 5000);

                if (autoSpeakCheckbox && autoSpeakCheckbox.checked) speakText(msg);
            });

            if (speakBtn) {
                speakBtn.addEventListener('click', () => {
                    const text = (sidebarMsgEl && sidebarMsgEl.textContent) || messages[idx] || messages[0];
                    speakText(text);
                });
            }
        })();

        (function keepGlobbieClearOfSidebar() {
            const widget = document.getElementById('globbie-widget');
            const sidebar = document.getElementById('sidebar');
            if (!widget || !sidebar) return;

            function updatePosition() {
                const vw = window.innerWidth || document.documentElement.clientWidth;
                if (vw <= 720) {
                    widget.style.right = '20px';
                    widget.style.left = 'auto';
                    return;
                }

                const sidebarStyle = getComputedStyle(sidebar);
                const isVisible = sidebarStyle.display !== 'none' && sidebarStyle.visibility !== 'hidden' && sidebarStyle.transform !== 'translateX(-100%)';

                if (isVisible) {
                    const sidebarWidth = sidebar.offsetWidth || 300;
                    widget.style.right = `calc(${20}px + ${sidebarWidth}px)`;
                    widget.style.left = 'auto';
                } else {
                    widget.style.right = '20px';
                    widget.style.left = 'auto';
                }
            }

            window.addEventListener('resize', updatePosition);
            window.addEventListener('orientationchange', updatePosition);
            updatePosition();

            const mo = new MutationObserver(() => updatePosition());
            mo.observe(sidebar, { attributes: true, attributeFilter: ['class', 'style'] });

            window.setTimeout(updatePosition, 350);
        })();
    </script>

</body>
</html>